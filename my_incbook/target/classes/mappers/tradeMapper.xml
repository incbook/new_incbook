<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="my_incbook.mapper.tradeMapper">
	<resultMap id="tradeMap" type="TradeVo">
		<id property="id" column="id" />
		<result property="ownId" column="own_id" />
		<result property="memberId" column="member_id" />
		<result property="regdate" column="regdate" />
		<result property="detailLocation" column="detail_location" />
		<result property="tradeDate" column="trade_date" />
		<result property="tradeTime" column="trade_time" />
		<result property="totalAmount" column="total_amount" />
		<discriminator javaType="String" column="trade_type">
			<case value="대여중" resultMap="rentMap" />
		</discriminator>
		<association property="member">
			<id property="id" column="id" />
			<result property="loginId" column="login_id" />
			<result property="password" column="password" />
			<result property="address" column="address" />
			<result property="email" column="email" />
			<result property="phone" column="phone" />
			<result property="nickname" column="nickname" />
			<result property="grade" column="grade" />
			<result property="jumin" column="jumin" />
			<result property="point" column="point" />
			<result property="good" column="good" />
			<result property="hate" column="hate" />
		</association>
		<association property="own" >
			<id property="realationId" column="id" />
			<result property="bookId" column="book_id" />
			<result property="memberId" column="member_id" />
			<result property="rentCount" column="rent_count" />
			<result property="rentCheck" column="rent_check" />
			<result property="state" column="state" />
			<result property="isRent" column="is_rent" />
			<result property="isSell" column="is_sell" />
			<result property="fee" column="fee" />
			<result property="selectPeriod" column="select_period" />
			<result property="rentAvailable" column="rent_available" />
			<result property="rentLocation" column="rent_location" />
		</association>
		<association property="book" >
			<id property="id" column="id" />
			<result property="title" column="title" />
			<result property="genre" column="genre" />
			<result property="writer" column="writer" />
			<result property="publisher" column="publisher" />
			<result property="regdate" column="regdate" />
			<result property="updatedate" column="updatedate" />
			<result property="viewCount" column="view_count" />
			<result property="averageScore" column="average_score" />
			<result property="finalUpdateMemberId" column="final_update_member_id" />
		</association>
	</resultMap>

	<resultMap id="rentMap" type="RentVO" extends="tradeMap">
		<id property="id" column="id" />
		<result property="rentDate" column="rent_date" />
		<result property="isReturn" column="is_return" />
	</resultMap>
	
	
	<insert id="insertTrade" useGeneratedKeys="true" keyProperty="id">
		insert into trade (own_id, member_id, datail_location,
							trade_date, trade_time, total_amount, trade_type
		values 			  (#{ownId}, #{memberId}, #{detailLocation},
							#{tradeDate}, #{tradeTime}, #{totalAmount}, '대여') 
	</insert>

	<insert id="insertRent">
		insert into rent (id, rent_date, is_return)
		values 			  (#{trade.id}, #{returnDate}, '대여예약')
	</insert>

	<select id="findLendersByMemberId" resultMap="tradeMap">
		select * 
		from trade t 
		join rent r
			on t.id = r.id
		join member m
			on t.member_id = m.id
		join own o
			on t.own_id = o.id
		join book b
			on o.book_id = b.id
		where t.member_id = #{id}
	</select>

	<select id="findOwnerByMemberId" resultMap="tradeMap">
		select * 
		from trade t 
		join rent r
			on t.id = r.id
		join member m
			on t.member_id = m.id
		join own o
			on t.own_id = o.id
		join book b
			on o.book_id = b.id
		where t.owner_id = #{id}
	</select>

</mapper>